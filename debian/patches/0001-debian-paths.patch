From: Leon Bogaert <leon@tim-online.nl>
Date: Sun, 2 Feb 2014 14:29:23 +0100
Subject: debian-paths

---
 cron.daily                     | 32 ++++++++++++++++----------------
 files/internals/functions      | 14 +++++++-------
 files/internals/hexfifo.pl     |  2 +-
 files/internals/internals.conf | 33 ++++++++++++++++++---------------
 files/internals/scan.etpl      |  2 +-
 files/internals/tlog           |  2 +-
 files/maldet                   |  4 ++--
 files/modsec.sh                |  2 +-
 8 files changed, 47 insertions(+), 44 deletions(-)

diff --git a/cron.daily b/cron.daily
index 8565693..28f8e3e 100755
--- a/cron.daily
+++ b/cron.daily
@@ -1,11 +1,11 @@
 #!/bin/bash
 export PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:$PATH
-. /usr/local/maldetect/conf.maldet
+. /etc/maldetect/conf.maldet
 
 find=`which find 2> /dev/null`
 if [ "$find" ]; then
 	# prune any quarantine/session/tmp data older than 14 days
-	tmpdirs="/usr/local/maldetect/tmp /usr/local/maldetect/sess /usr/local/maldetect/quarantine /usr/local/maldetect/pub"
+	tmpdirs="/tmp/maldetect /var/lib//maldetect/sess /var/lib/maldetect/quarantine /var/lib/maldetect/pub"
 	for dir in $tmpdirs; do
 	 if [ -d "$dir" ]; then
 	  $find $dir -type f -mtime +14 -print0 | xargs -0 rm -f >> /dev/null 2>&1
@@ -16,46 +16,46 @@ fi
 if [ "$autoupdate_version" == "1" ]; then
 	# check for new release version
 	sleep $(echo $RANDOM | cut -c1-3) >> /dev/null 2>&1
-	/usr/local/maldetect/maldet -d >> /dev/null 2>&1
+	maldet -d >> /dev/null 2>&1
 fi
 
 if [ "$autoupdate_signatures" == "1" ]; then
 	# check for new definition set
 	sleep $(echo $RANDOM | cut -c1-3) >> /dev/null 2>&1
-	/usr/local/maldetect/maldet -u >> /dev/null 2>&1
+	maldet -u >> /dev/null 2>&1
 fi
 
 # if were running inotify monitoring, send daily hit summary
 if [ "$(ps -A --user root -o "comm" | grep inotifywait)" ]; then
-        /usr/local/maldetect/maldet --alert-daily >> /dev/null 2>&1
+        maldet --alert-daily >> /dev/null 2>&1
 else
 	# scan the last 2 days of file changes
 	if [ -d "/home/virtual" ] && [ -d "/usr/lib/opcenter" ]; then
 		# ensim
-	        /usr/local/maldetect/maldet -b -r /home/virtual/?/fst/var/www/html 2 >> /dev/null 2>&1
-	        /usr/local/maldetect/maldet -b -r /home/virtual/?/fst/home/?/public_html 2 >> /dev/null 2>&1
+	        maldet -b -r /home/virtual/?/fst/var/www/html 2 >> /dev/null 2>&1
+	        maldet -b -r /home/virtual/?/fst/home/?/public_html 2 >> /dev/null 2>&1
 	elif [ -d "/etc/psa" ] && [ -d "/var/lib/psa" ]; then
 		# psa
-		/usr/local/maldetect/maldet -b -r /var/www/vhosts/?/httpdocs 2 >> /dev/null 2>&1
-		/usr/local/maldetect/maldet -b -r /var/www/vhosts/?/subdomains/?/httpdocs 2 >> /dev/null 2>&1
+		maldet -b -r /var/www/vhosts/?/httpdocs 2 >> /dev/null 2>&1
+		maldet -b -r /var/www/vhosts/?/subdomains/?/httpdocs 2 >> /dev/null 2>&1
         elif [ -d "/usr/local/directadmin" ]; then
                 # DirectAdmin
-                /usr/local/maldetect/maldet -b -r /var/www/html/?/ 2 >> /dev/null 2>&1
-                /usr/local/maldetect/maldet -b -r /home?/?/domains/?/public_html 2 >> /dev/null 2>&1
+                maldet -b -r /var/www/html/?/ 2 >> /dev/null 2>&1
+                maldet -b -r /home?/?/domains/?/public_html 2 >> /dev/null 2>&1
 	elif [ -d "/etc/webmin/virtual-server" ]; then
 		# Virtualmin
-                /usr/bin/maldet -b -r /home/?/public_html 2 >> /dev/null 2>&1
-		/usr/bin/maldet -b -r /home/?/domains/?/public_html 2 >> /dev/null 2>&1
+		maldet -b -r /home/?/public_html 2 >> /dev/null 2>&1
+		maldet -b -r /home/?/domains/?/public_html 2 >> /dev/null 2>&1
 	else
 		# cpanel, interworx and other standard home/user/public_html setups
-	        /usr/local/maldetect/maldet -b -r /home?/?/public_html 2 >> /dev/null 2>&1
+	        maldet -b -r /home?/?/public_html 2 >> /dev/null 2>&1
 	fi
 
 	# scan default apache docroot paths
 	if [ -d "/var/www/html" ]; then
-		/usr/local/maldetect/maldet -b -r /var/www/html 2 >> /dev/null 2>&1
+		maldet -b -r /var/www/html 2 >> /dev/null 2>&1
 	fi
 	if [ -d "/usr/local/apache/htdocs" ]; then
-		/usr/local/maldetect/maldet -b -r /usr/local/apache/htdocs 2 >> /dev/null 2>&1
+		maldet -b -r /usr/local/apache/htdocs 2 >> /dev/null 2>&1
 	fi
 fi
diff --git a/files/internals/functions b/files/internals/functions
index c72e623..b2a1d7b 100644
--- a/files/internals/functions
+++ b/files/internals/functions
@@ -309,7 +309,7 @@ usage $0 [ OPTION ]
     -s, --restore FILE|SCANID
        Restore file from quarantine queue to orginal path or restore all items from
        a specific SCANID
-       e.g: maldet --restore /usr/local/maldetect/quarantine/config.php.23754
+       e.g: maldet --restore $quardir/config.php.23754
        e.g: maldet --restore 050910-1534.21135
 
     -q, --quarantine SCANID
@@ -503,7 +503,7 @@ view_report() {
  rid="$1"
  if [ "$rid" == "list" ]; then
         tmpf=$tmpdir/.areps$$
-        for file in `ls /usr/local/maldetect/sess/session.[0-9]* 2> /dev/null`; do
+        for file in `ls $sessdir/session.[0-9]* 2> /dev/null`; do
                 SCANID=`cat $file | grep "SCAN ID"`
                 FILES=`cat $file | grep "TOTAL FILES" | sed 's/TOTAL //'`
                 HITS=`cat $file | grep "TOTAL HITS" | sed 's/TOTAL //'`
@@ -1366,11 +1366,11 @@ fi
 }
 
 gensigs() {
- runtime_ndb="$inspath/tmp/.runtime.user.$$.ndb"
- runtime_hdb="$inspath/tmp/.runtime.user.$$.hdb"
- ln -fs $runtime_ndb $inspath/sigs/lmd.user.ndb
- ln -fs $runtime_hdb $inspath/sigs/lmd.user.hdb
- runtime_hexstrings="$inspath/tmp/.runtime.hexsigs.$$"
+ runtime_ndb="$tmpdir/.runtime.user.$$.ndb"
+ runtime_hdb="$tmpdir/.runtime.user.$$.hdb"
+ ln -fs $runtime_ndb $sigdir/lmd.user.ndb
+ ln -fs $runtime_hdb $sigdir/lmd.user.hdb
+ runtime_hexstrings="$tmpdir/.runtime.hexsigs.$$"
  if [ -s "$sig_cust_hex_file" ]; then
 	cat "$sig_hex_file" "$sig_cust_hex_file" > $runtime_hexstrings
  else
diff --git a/files/internals/hexfifo.pl b/files/internals/hexfifo.pl
index 72f53ee..131391e 100644
--- a/files/internals/hexfifo.pl
+++ b/files/internals/hexfifo.pl
@@ -15,7 +15,7 @@ if ($#ARGV != "0") {
 
 $hexfile = $ARGV[0];
 
-$named_pipe_name = "/usr/local/maldetect/internals/hexfifo";
+$named_pipe_name = "/var/lib/maldetect/hexfifo";
 $timeout = "1";
 
 if (-p $named_pipe_name) {
diff --git a/files/internals/internals.conf b/files/internals/internals.conf
index cdb07b1..9eb8918 100644
--- a/files/internals/internals.conf
+++ b/files/internals/internals.conf
@@ -8,7 +8,10 @@
 ##
 #
 
-logdir=$inspath/logs
+logdir="/var/log/maldetect"
+confdir="/etc/maldetect"
+vardir="/var/lib/maldetect"
+libdir="/usr/lib/maldetect"
 maldet_log=$logdir/event_log
 clamscan_log=$logdir/clamscan_log
 datestamp=`date +"%m%d%y-%H%M"`
@@ -42,15 +45,15 @@ pidof=`which pidof 2> /dev/null`
 stat=`which stat 2> /dev/null`
 
 suppress_cleanhit=$email_ignore_clean
-ignore_paths=$inspath/ignore_paths
-ignore_sigs=$inspath/ignore_sigs
-ignore_inotify=$inspath/ignore_inotify
-ignore_file_ext=$inspath/ignore_file_ext
-quardir=$inspath/quarantine
-sessdir=$inspath/sess
-sigdir=$inspath/sigs
-cldir=$inspath/clean
-tmpdir=$inspath/tmp
+ignore_paths=$confdir/ignore_paths
+ignore_sigs=$confdir/ignore_sigs
+ignore_inotify=$confdir/ignore_inotify
+ignore_file_ext=$confdir/ignore_file_ext
+quardir=$vardir/quarantine
+sessdir=$vardir/sess
+sigdir=$vardir/sigs
+cldir=$vardir/clean
+tmpdir=/tmp/maldetect
 
 sig_version_file=$sigdir/maldet.sigs.ver
 sig_version=`cat $sig_version_file`
@@ -62,17 +65,17 @@ sig_md5_file=$sigdir/md5v2.dat
 sig_hex_file=$sigdir/hex.dat
 sig_cav_hex_file=$sigdir/rfxn.ndb
 sig_cav_md5_file=$sigdir/rfxn.hdb
-sig_cust_md5_file=$sigdir/custom.md5.dat
-sig_cust_hex_file=$sigdir/custom.hex.dat
+sig_cust_md5_file=$confdir/custom.md5.dat
+sig_cust_hex_file=$confdir/custom.hex.dat
 
-lmd_versionsion_file=$inspath/VERSION
+lmd_versionsion_file=$varlib/VERSION
 lmd_version=$ver
 if [ ! "$report_usage" == "0" ]; then
 	lmd_referer="LMD:$ver:$hostid"
 else
 	lmd_referer="LMD:$ver"
 fi
-lmd_hash_file=$inspath/VERSION.hash
+lmd_hash_file=$varlib/VERSION.hash
 lmd_hash_url=http://cdn.rfxn.com/downloads/maldet.current.hash.beta
 lmd_version_url=http://cdn.rfxn.com/downloads/maldet.current.ver.beta
 
@@ -81,7 +84,7 @@ inotify=`which inotifywait 2> /dev/null`
 inotify_log="$inspath/logs/inotify_log"
 inotify_user_watches=128
 inotify_trim=150000
-hex_fifo_path=$inspath/internals/hexfifo
+hex_fifo_path=$vardir/hexfifo
 hex_fifo_script=$inspath/internals/hexfifo.pl
 hex_string_script=$inspath/internals/hexstring.pl
 scan_user_access_minuid=40
diff --git a/files/internals/scan.etpl b/files/internals/scan.etpl
index 11a40d3..219fdaf 100644
--- a/files/internals/scan.etpl
+++ b/files/internals/scan.etpl
@@ -25,7 +25,7 @@ EOF
 if [ "$quarantine_hits" == "0" ] && [ ! "$tot_hits" == "0" ]; then
  echo "WARNING: Automatic quarantine of hits is currently disabled, detected threats are still be accessible to users!" >> $tmpf
  echo "To enable, set quarantine_hits=1 in $inspath/conf.maldet and/or to quarantine hits from this scan run:" >> $tmpf
- echo -e "/usr/local/sbin/maldet -q $datestamp.$$\n" >> $tmpf
+ echo -e "/usr/bin/maldet -q $datestamp.$$\n" >> $tmpf
 fi
 if [ "$quarantine_clean" == "1" ]; then
   if [ "$type" == "scan" ] && [ -f "$sessdir/clean.$$" ] && [ ! -z "$(cat $sessdir/clean.$$)" ]; then
diff --git a/files/internals/tlog b/files/internals/tlog
index e55c0f5..0606480 100644
--- a/files/internals/tlog
+++ b/files/internals/tlog
@@ -24,7 +24,7 @@ PATH=/sbin:/usr/sbin:/usr/bin:/usr/local/bin:/usr/local/sbin:$PATH ; export PATH
 
 
 # Base run path; no trailing slash
-BASERUN="/usr/local/maldetect/tmp"
+BASERUN="/tmp/maldetect"
 
 if [ "$1" == "" ] && [ "$2" == "" ]; then
 	echo "$0 usage: [file] [tlog]"
diff --git a/files/maldet b/files/maldet
index 3b58350..3a2f72e 100755
--- a/files/maldet
+++ b/files/maldet
@@ -10,8 +10,8 @@
 PATH=$PATH:/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin
 ver=1.5
 
-inspath=/usr/local/maldetect
-cnf=$inspath/conf.maldet
+inspath=/usr/share/maldetect
+cnf=/etc/maldetect/conf.maldet
 intcnf=$inspath/internals/internals.conf
 intfunc=$inspath/internals/functions
 
diff --git a/files/modsec.sh b/files/modsec.sh
index 5a0cfa1..e38e1be 100755
--- a/files/modsec.sh
+++ b/files/modsec.sh
@@ -1,3 +1,3 @@
 #!/bin/bash
 file="$1"
-cd /tmp ; /usr/local/maldetect/maldet --config-option quar_hits=1,quar_clean=0,clamav_scan=0 --modsec -a "$file"
+cd /tmp ; /usr/bin/maldet --config-option quar_hits=1,quar_clean=0,clamav_scan=0 --modsec -a "$file"
